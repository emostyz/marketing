
> marketing-deck-platform@1.0.0 dev
> next dev --turbopack

 ⚠ Warning: Found multiple lockfiles. Selecting /Users/emilmostrom/pnpm-lock.yaml.
   Consider removing the lockfiles at:
   * /Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/package-lock.json

   ▲ Next.js 15.4.0-canary.88 (Turbopack)
   - Local:        http://localhost:3000
   - Network:      http://192.168.1.207:3000
   - Environments: .env.local
   - Experiments (use with caution):
     ✓ ppr
     ✓ nodeMiddleware
     ✓ clientSegmentCache

 ✓ Starting...
 ✓ Compiled middleware in 129ms
 ✓ Ready in 1054ms
 ○ Compiling /api/upload ...
 ✓ Compiled /api/upload in 681ms
Error: Route "/api/upload" used `cookies().get('sb-waddrfstpqkvdfwbxvfw-auth-token')`. `cookies()` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis
    at getItemAsync (../../../src/lib/helpers.ts:129:30)
    at SupabaseAuthClient.__loadSession (../../src/GoTrueClient.ts:1316:46)
    at SupabaseAuthClient._useSession (../../src/GoTrueClient.ts:1274:32)
    at SupabaseAuthClient._emitInitialSession (../../src/GoTrueClient.ts:1876:22)
    at <unknown> (../../src/GoTrueClient.ts:1868:13)
    at <unknown> (../../src/GoTrueClient.ts:1206:25)
    at SupabaseAuthClient.lockNoOp [as lock] (../../src/GoTrueClient.ts:130:15)
    at SupabaseAuthClient._acquireLock (../../src/GoTrueClient.ts:1200:24)
    at <unknown> (../../src/GoTrueClient.ts:1867:17)
Error: Route "/api/upload" used `cookies().get('sb-waddrfstpqkvdfwbxvfw-auth-token.0')`. `cookies()` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis
    at getItemAsync (../../../src/lib/helpers.ts:129:30)
    at SupabaseAuthClient.__loadSession (../../src/GoTrueClient.ts:1316:46)
    at SupabaseAuthClient._useSession (../../src/GoTrueClient.ts:1274:32)
    at SupabaseAuthClient._emitInitialSession (../../src/GoTrueClient.ts:1876:22)
    at <unknown> (../../src/GoTrueClient.ts:1868:13)
    at <unknown> (../../src/GoTrueClient.ts:1206:25)
    at SupabaseAuthClient.lockNoOp [as lock] (../../src/GoTrueClient.ts:130:15)
    at SupabaseAuthClient._acquireLock (../../src/GoTrueClient.ts:1200:24)
    at <unknown> (../../src/GoTrueClient.ts:1867:17)
Error: Route "/api/upload" used `cookies().get('sb-waddrfstpqkvdfwbxvfw-auth-token')`. `cookies()` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis
    at getItemAsync (../../../src/lib/helpers.ts:129:30)
    at SupabaseAuthClient.__loadSession (../../src/GoTrueClient.ts:1316:46)
    at SupabaseAuthClient._useSession (../../src/GoTrueClient.ts:1274:32)
    at <unknown> (../../src/GoTrueClient.ts:1162:18)
    at <unknown> (../../src/GoTrueClient.ts:1184:23)
Error: Route "/api/upload" used `cookies().get('sb-waddrfstpqkvdfwbxvfw-auth-token.0')`. `cookies()` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis
    at getItemAsync (../../../src/lib/helpers.ts:129:30)
    at SupabaseAuthClient.__loadSession (../../src/GoTrueClient.ts:1316:46)
    at SupabaseAuthClient._useSession (../../src/GoTrueClient.ts:1274:32)
    at <unknown> (../../src/GoTrueClient.ts:1162:18)
    at <unknown> (../../src/GoTrueClient.ts:1184:23)
Using demo mode for file upload testing
📊 File parsed successfully: {
  fileName: 'test_user_data.csv',
  rowCount: 6,
  columns: 7,
  dataQuality: 'excellent',
  timeSeriesDetected: true
}
 ✓ Compiled /api/presentations/session in 385ms
 POST /api/presentations/session 401 in 446ms
 POST /api/upload 200 in 1356ms
 ✓ Compiled /api/openai/enhanced-analyze in 398ms
🧠 Enhanced Analysis - Starting request processing
🧠 Enhanced Analysis - Request body received: [ 'data', 'context', 'timeFrame', 'requirements' ]
🧠 Enhanced Analysis - Extracted data: {
  dataLength: 1,
  isArray: true,
  firstDataItem: [ 'fileId', 'fileName', 'data', 'columns', 'dataType' ],
  contextKeys: [ 'industry', 'targetAudience', 'businessContext', 'description' ],
  timeFrameKeys: [ 'start', 'end', 'dataFrequency', 'analysisType', 'comparisons' ],
  requirementsKeys: [ 'slidesCount', 'presentationDuration', 'focusAreas', 'style' ]
}
🧠 Enhanced Analysis - All validations passed, getting user context
🧠 Enhanced Analysis - User profile retrieved: No
🧠 Enhanced Analysis - Enhanced context prepared
🧠 Enhanced Analysis - Transformed timeFrame: {
  primaryPeriod: {
    start: '2024-01-01',
    end: '2024-06-01',
    label: '2024-01-01 to 2024-06-01'
  },
  analysisType: 'custom',
  includeTrends: true,
  includeSeasonality: true,
  includeOutliers: true
}
🧠 Enhanced Analysis - Transformed requirements: {
  slideCount: 8,
  targetDuration: 15,
  structure: 'ai_suggested',
  keyPoints: [
    'Revenue Growth',
    'Customer Acquisition',
    'Conversion Optimization'
  ],
  slideDescriptions: [],
  audienceType: 'executive',
  presentationStyle: 'formal',
  includeAppendix: true,
  includeSources: true
}
🧠 Enhanced Analysis - Brain initialized, performing analysis...
🧠 Enhanced Analysis - Processing file data array
🧠 Enhanced Analysis - Flattened data length: 6
🧠 EnhancedBrainV2: Starting analysis...
🧠 EnhancedBrainV2: Input validation passed
🧠 EnhancedBrainV2: Phase 1 - Initial Data Scan
🧠 EnhancedBrainV2: performInitialScan - Starting...
🧠 EnhancedBrainV2: performInitialScan - Making OpenAI API call...
🧠 EnhancedBrainV2: performInitialScan - OpenAI response received
🧠 EnhancedBrainV2: performInitialScan - Parsing JSON response...
🧠 EnhancedBrainV2: performInitialScan - Completed successfully
🧠 EnhancedBrainV2: Phase 2 - Deep Pattern Analysis
🧠 EnhancedBrainV2: Phase 3 - Novel Insight Generation
❌ EnhancedBrainV2.analyzeData Error: TypeError: Cannot read properties of undefined (reading 'join')
    at EnhancedBrainV2.generateNovelInsights (lib/ai/enhanced-brain-v2.ts:655:70)
    at EnhancedBrainV2.analyzeData (lib/ai/enhanced-brain-v2.ts:354:39)
    at async POST (app/api/openai/enhanced-analyze/route.ts:136:19)
  653 | EXECUTIVE BRIEFING:
  654 | Industry: ${context.industry} | Business Context: ${context.businessContext}
> 655 | Data Quality: ${context.dataQuality} | Key Factors: ${context.factors.join(', ')}
      |                                                                      ^
  656 |
  657 | ANALYTICAL FOUNDATION:
  658 | ${JSON.stringify(patternAnalysis, null, 2)}
Error name: TypeError
Error message: Cannot read properties of undefined (reading 'join')
Error stack: TypeError: Cannot read properties of undefined (reading 'join')
    at EnhancedBrainV2.generateNovelInsights (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/.next/server/chunks/[root-of-the-server]__ecde7161._.js:1094:71)
    at EnhancedBrainV2.analyzeData (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/.next/server/chunks/[root-of-the-server]__ecde7161._.js:816:46)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async POST (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/.next/server/chunks/[root-of-the-server]__ecde7161._.js:2241:24)
    at async AppRouteRouteModule.do (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/compiled/next-server/app-route-turbo-experimental.runtime.dev.js:5:37894)
    at async AppRouteRouteModule.handle (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/compiled/next-server/app-route-turbo-experimental.runtime.dev.js:5:45039)
    at async responseGenerator (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/.next/server/chunks/node_modules_next_39c78298._.js:14473:38)
    at async AppRouteRouteModule.handleResponse (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/compiled/next-server/app-route-turbo-experimental.runtime.dev.js:1:190411)
    at async handleResponse (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/.next/server/chunks/node_modules_next_39c78298._.js:14535:32)
    at async handler (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/.next/server/chunks/node_modules_next_39c78298._.js:14587:13)
    at async doRender (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/base-server.js:1589:34)
    at async DevServer.renderToResponseWithComponentsImpl (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/base-server.js:1931:13)
    at async DevServer.renderPageComponent (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/base-server.js:2397:24)
    at async DevServer.renderToResponseImpl (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/base-server.js:2437:32)
    at async DevServer.pipeImpl (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/base-server.js:1033:25)
    at async NextNodeServer.handleCatchallRenderRequest (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/next-server.js:391:17)
    at async DevServer.handleRequestImpl (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/base-server.js:924:17)
    at async /Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/dev/next-dev-server.js:398:20
    at async Span.traceAsyncFn (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/trace/trace.js:157:20)
    at async DevServer.handleRequest (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/dev/next-dev-server.js:394:24)
    at async invokeRender (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/lib/router-server.js:239:21)
    at async handleRequest (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/lib/router-server.js:436:24)
    at async requestHandlerImpl (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/lib/router-server.js:464:13)
    at async Server.requestListener (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/lib/start-server.js:216:13)
❌ Enhanced analysis error: TypeError: Cannot read properties of undefined (reading 'join')
    at EnhancedBrainV2.generateNovelInsights (lib/ai/enhanced-brain-v2.ts:655:70)
    at EnhancedBrainV2.analyzeData (lib/ai/enhanced-brain-v2.ts:354:39)
    at async POST (app/api/openai/enhanced-analyze/route.ts:136:19)
  653 | EXECUTIVE BRIEFING:
  654 | Industry: ${context.industry} | Business Context: ${context.businessContext}
> 655 | Data Quality: ${context.dataQuality} | Key Factors: ${context.factors.join(', ')}
      |                                                                      ^
  656 |
  657 | ANALYTICAL FOUNDATION:
  658 | ${JSON.stringify(patternAnalysis, null, 2)}
Error name: TypeError
Error message: Cannot read properties of undefined (reading 'join')
Error stack: TypeError: Cannot read properties of undefined (reading 'join')
    at EnhancedBrainV2.generateNovelInsights (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/.next/server/chunks/[root-of-the-server]__ecde7161._.js:1094:71)
    at EnhancedBrainV2.analyzeData (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/.next/server/chunks/[root-of-the-server]__ecde7161._.js:816:46)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async POST (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/.next/server/chunks/[root-of-the-server]__ecde7161._.js:2241:24)
    at async AppRouteRouteModule.do (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/compiled/next-server/app-route-turbo-experimental.runtime.dev.js:5:37894)
    at async AppRouteRouteModule.handle (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/compiled/next-server/app-route-turbo-experimental.runtime.dev.js:5:45039)
    at async responseGenerator (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/.next/server/chunks/node_modules_next_39c78298._.js:14473:38)
    at async AppRouteRouteModule.handleResponse (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/compiled/next-server/app-route-turbo-experimental.runtime.dev.js:1:190411)
    at async handleResponse (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/.next/server/chunks/node_modules_next_39c78298._.js:14535:32)
    at async handler (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/.next/server/chunks/node_modules_next_39c78298._.js:14587:13)
    at async doRender (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/base-server.js:1589:34)
    at async DevServer.renderToResponseWithComponentsImpl (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/base-server.js:1931:13)
    at async DevServer.renderPageComponent (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/base-server.js:2397:24)
    at async DevServer.renderToResponseImpl (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/base-server.js:2437:32)
    at async DevServer.pipeImpl (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/base-server.js:1033:25)
    at async NextNodeServer.handleCatchallRenderRequest (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/next-server.js:391:17)
    at async DevServer.handleRequestImpl (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/base-server.js:924:17)
    at async /Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/dev/next-dev-server.js:398:20
    at async Span.traceAsyncFn (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/trace/trace.js:157:20)
    at async DevServer.handleRequest (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/dev/next-dev-server.js:394:24)
    at async invokeRender (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/lib/router-server.js:239:21)
    at async handleRequest (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/lib/router-server.js:436:24)
    at async requestHandlerImpl (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/lib/router-server.js:464:13)
    at async Server.requestListener (/Users/emilmostrom/Desktop/marketing-deck-platform/marketing-deck-platform/node_modules/next/dist/server/lib/start-server.js:216:13)
Full error object: {}
 POST /api/openai/enhanced-analyze 500 in 45444ms
 ✓ Compiled middleware in 3ms
